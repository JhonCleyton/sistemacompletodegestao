{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Nova Nota</h2>
<form method="POST" id="notaForm" class="needs-validation" novalidate>
    <div class="card mb-4">
        <div class="card-header">
            <h5>Informações Básicas</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Número da Nota</label>
                    <input type="text" class="form-control" name="numero" readonly value="{{ novo_numero }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipo de Ave</label>
                    <select class="form-select" name="tipo_ave">
                        <option value="">Selecione...</option>
                        <option value="Frango">Frango</option>
                        <option value="Galinha Leve">Galinha Leve</option>
                        <option value="Galinha Matriz">Galinha Matriz</option>
                        <option value="Galinha Vermelha">Galinha Vermelha</option>
                        <option value="Galo">Galo</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Número de Cargas</label>
                    <input type="number" class="form-control" name="num_cargas">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Ordem da Carga</label>
                    <input type="text" class="form-control" name="ordem_carga" placeholder="Ex: 3/5">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data de Abate</label>
                    <input type="date" class="form-control" name="data_abate">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Agenciador</label>
                    <input type="text" class="form-control" name="agenciador">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Informações do Transporte</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Motorista</label>
                    <input type="text" class="form-control" name="motorista">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Transportadora</label>
                    <input type="text" class="form-control" name="transportadora">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Placa do Veículo</label>
                    <input type="text" class="form-control" name="placa_veiculo">
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">KM Saída</label>
                    <input type="number" step="0.1" class="form-control" name="km_saida">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">KM Chegada</label>
                    <input type="number" step="0.1" class="form-control" name="km_chegada">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">KM Total</label>
                    <input type="number" step="0.1" class="form-control" name="km_total" readonly>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Frete Status</label>
                    <select class="form-select" name="frete_status">
                        <option value="">Selecione...</option>
                        <option value="A Pagar">A Pagar</option>
                        <option value="Inclusive">Inclusive</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Valor do Frete</label>
                    <input type="number" step="0.01" class="form-control" name="valor_frete">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Pedágios</label>
                    <input type="number" step="0.01" class="form-control" name="pedagios" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Outras Despesas</label>
                    <input type="number" step="0.01" class="form-control" name="outras_despesas" value="0">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Informações do Produtor e Documentação</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Nome do Produtor</label>
                    <input type="text" class="form-control" name="produtor">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" name="estado">
                        <option value="">Selecione...</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AP">Amapá</option>
                        <option value="AM">Amazonas</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Ceará</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Espírito Santo</option>
                        <option value="GO">Goiás</option>
                        <option value="MA">Maranhão</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="PA">Pará</option>
                        <option value="PB">Paraíba</option>
                        <option value="PR">Paraná</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piauí</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rondônia</option>
                        <option value="RR">Roraima</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SP">São Paulo</option>
                        <option value="SE">Sergipe</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nota Fiscal</label>
                    <input type="text" class="form-control" name="nota_fiscal">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data da Nota Fiscal</label>
                    <input type="date" class="form-control" name="data_nf">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">GTA</label>
                    <input type="text" class="form-control" name="gta">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data da GTA</label>
                    <input type="date" class="form-control" name="data_gta">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Informações das Aves</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Aves na Granja</label>
                    <input type="number" class="form-control" name="aves_granja">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Aves Mortas</label>
                    <input type="number" class="form-control" name="aves_mortas">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Aves Recebidas</label>
                    <input type="number" class="form-control" name="aves_recebidas">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Aves Contador</label>
                    <input type="number" class="form-control" name="aves_contador">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Quantidade de Caixas</label>
                    <input type="number" class="form-control" name="qtd_caixas">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Caixas Vazias</label>
                    <input type="number" class="form-control" name="caixas_vazias" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Valor por KG</label>
                    <input type="number" step="0.01" class="form-control" name="valor_kg">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Peso na Granja</label>
                    <input type="number" step="0.01" class="form-control" name="peso_granja">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Peso no Frigorífico</label>
                    <input type="number" step="0.01" class="form-control" name="peso_frigorifico">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Avarias e Quebras</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Mortalidade por Excesso</label>
                    <input type="number" step="0.01" class="form-control" name="mortalidade_excesso" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Aves Molhadas na Granja</label>
                    <input type="number" step="0.01" class="form-control" name="aves_molhadas_granja" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Aves Molhadas por Chuva</label>
                    <input type="number" step="0.01" class="form-control" name="aves_molhadas_chuva" value="0">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Quebra por Maus Tratos</label>
                    <input type="number" step="0.01" class="form-control" name="quebra_maus_tratos" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Aves com Papo Cheio</label>
                    <input type="number" step="0.01" class="form-control" name="aves_papo_cheio" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Outras Quebras</label>
                    <input type="number" step="0.01" class="form-control" name="outras_quebras" value="0">
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">Descrição das Quebras</label>
                    <textarea class="form-control" name="descricao_quebras" rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Fechamento do Frete</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Adiantamento do Frete</label>
                    <input type="number" step="0.01" class="form-control" name="adiantamento_frete" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Valor do Combustível</label>
                    <input type="number" step="0.01" class="form-control" name="valor_combustivel" value="0">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Total do Frete</label>
                    <input type="number" step="0.01" class="form-control" name="total_frete" readonly>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <button type="button" class="btn btn-secondary me-md-2" onclick="window.history.back()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar Nota</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('notaForm');
    
    // Cálculo de KM total
    const kmSaida = form.querySelector('[name="km_saida"]');
    const kmChegada = form.querySelector('[name="km_chegada"]');
    const kmTotal = form.querySelector('[name="km_total"]');
    
    [kmSaida, kmChegada].forEach(input => {
        input.addEventListener('input', () => {
            if (kmSaida.value && kmChegada.value) {
                kmTotal.value = (parseFloat(kmChegada.value) - parseFloat(kmSaida.value)).toFixed(1);
            }
        });
    });

    // Cálculo do total do frete
    const valorFrete = form.querySelector('[name="valor_frete"]');
    const adiantamento = form.querySelector('[name="adiantamento_frete"]');
    const combustivel = form.querySelector('[name="valor_combustivel"]');
    const totalFrete = form.querySelector('[name="total_frete"]');

    [valorFrete, adiantamento, combustivel].forEach(input => {
        input.addEventListener('input', () => {
            const total = parseFloat(valorFrete.value || 0) - 
                         parseFloat(adiantamento.value || 0) - 
                         parseFloat(combustivel.value || 0);
            totalFrete.value = total.toFixed(2);
        });
    });

    // Validação do formulário
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
